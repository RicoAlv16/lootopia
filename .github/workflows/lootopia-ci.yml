name:
  Lootopia vulnearability audit and deploy

  # âœ… La qualitÃ© de code (PHP)
  # âœ… Les vulnÃ©rabilitÃ©s connues
  # âœ… Les bugs potentiels
  # âœ… Les mauvaises pratiques
  # âœ… La sÃ©curitÃ©
  # âœ… Les vulnÃ©rabilitÃ©s des images et packages
  # âœ… Tests unitaires
  # âœ… Monitoring avec Grafana/Prometheus

on:
  push:
    branches:
      - main
      - dev
      - prod

jobs:
  sonar-analysis:
    name: Analyse SonarQube
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  unit-tests:
    name: Tests unitaires
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js pour Backend
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./lootopia-back/package-lock.json"

      - name: Setup Node.js pour Frontend
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "./lootopia-front/package-lock.json"

      - name: Installation des dÃ©pendances Backend
        run: |
          cd ./lootopia-back
          npm ci --legacy-peer-deps

      - name: Installation des dÃ©pendances Frontend
        run: |
          cd ./lootopia-front
          npm ci --legacy-peer-deps

      - name: Tests unitaires Backend
        run: |
          cd ./lootopia-back
          # Tests spÃ©cifiques fonctionnels
          npm run test -- --coverage --watchAll=false

      - name: Tests unitaires Frontend
        run: |
          cd ./lootopia-front
          # Exclusion des fichiers problÃ©matiques et tests spÃ©cifiques
          npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage

      - name: Upload des rapports de couverture
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            ./lootopia-back/coverage/
            ./lootopia-front/coverage/

  trivy-security-scan:
    name: Analyse de sÃ©curitÃ© Trivy
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Construction des images Docker
        run: |
          # Construction de l'image backend
          docker build -t lootopia-back:latest ./lootopia-back

          # Construction de l'image frontend
          docker build -t lootopia-front:latest ./lootopia-front

      - name: Installation de Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan des images Docker
        run: |
          # Scan de l'image backend
          trivy image --severity HIGH,CRITICAL --format table lootopia-back

          # Scan de l'image frontend
          trivy image --severity HIGH,CRITICAL --format table lootopia-front

      - name: Scan des dÃ©pendances des projets
        run: |
          # Scan des dÃ©pendances backend
          trivy fs --severity HIGH,CRITICAL ./lootopia-back

          # Scan des dÃ©pendances frontend
          trivy fs --severity HIGH,CRITICAL ./lootopia-front

      - name: Scan des fichiers de configuration
        run: |
          trivy config --severity HIGH,CRITICAL .

  dependency-check:
    name: Analyse des dÃ©pendances
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Configure Git
        run: |
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "git@github.com:"
          git config --global url."https://".insteadOf "git://"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          cd ./lootopia-front && npm install --legacy-peer-deps
          cd ../lootopia-back && npm install --legacy-peer-deps
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "Lootopia"
          path: "."
          format: "HTML"
          args: >
            --enableExperimental
            --failOnCVSS 11
            --suppression suppression.xml
            --scan ./lootopia-front
            --scan ./lootopia-back
            --nodeAuditSkipDevDependencies true
            --disableNodeAudit
            --disableYarnAudit
            --exclude ".*yarn\.lock.*"
            --exclude ".*node_modules.*"

      - name: Upload Test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Dependency Check Report
          path: reports

  secrets-scan:
    name: DÃ©tection de secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important pour avoir l'historique complet

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

  monitoring-setup:
    name: Configuration Grafana & Prometheus
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: CrÃ©ation des fichiers de configuration Prometheus
        run: |
          mkdir -p monitoring/prometheus
          cat > monitoring/prometheus/prometheus.yml << EOF
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          rule_files:
            # - "first_rules.yml"
            # - "second_rules.yml"

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            - job_name: 'lootopia-backend'
              static_configs:
                - targets: ['lootopia-back:3000']
              metrics_path: '/metrics'
              scrape_interval: 30s

            - job_name: 'lootopia-frontend'
              static_configs:
                - targets: ['lootopia-front:80']
              metrics_path: '/metrics'
              scrape_interval: 30s

            - job_name: 'node-exporter'
              static_configs:
                - targets: ['node-exporter:9100']
          EOF

      - name: CrÃ©ation du docker-compose pour monitoring
        run: |
          cat > monitoring/docker-compose.monitoring.yml << EOF
          version: '3.8'

          services:
            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              ports:
                - "9090:9090"
              volumes:
                - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
                - prometheus_data:/prometheus
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
                - '--web.console.libraries=/etc/prometheus/console_libraries'
                - '--web.console.templates=/etc/prometheus/consoles'
                - '--storage.tsdb.retention.time=200h'
                - '--web.enable-lifecycle'
              restart: unless-stopped

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              ports:
                - "3001:3000"
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=admin123
                - GF_USERS_ALLOW_SIGN_UP=false
              volumes:
                - grafana_data:/var/lib/grafana
                - ./grafana/provisioning:/etc/grafana/provisioning
              restart: unless-stopped

            node-exporter:
              image: prom/node-exporter:latest
              container_name: node-exporter
              ports:
                - "9100:9100"
              volumes:
                - /proc:/host/proc:ro
                - /sys:/host/sys:ro
                - /:/rootfs:ro
              command:
                - '--path.procfs=/host/proc'
                - '--path.rootfs=/rootfs'
                - '--path.sysfs=/host/sys'
                - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
              restart: unless-stopped

          volumes:
            prometheus_data:
            grafana_data:
          EOF

      - name: Test de la configuration Prometheus
        run: |
          # Utilisation de l'image prom/prometheus avec la commande correcte
          docker run --rm -v $(pwd)/monitoring/prometheus:/etc/prometheus --entrypoint=/bin/promtool prom/prometheus:latest check config /etc/prometheus/prometheus.yml

      - name: Upload des configurations de monitoring
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-configs
          path: monitoring/

  mock-deploy:
    name: DÃ©ploiement fictif (simulation)
    runs-on: ubuntu-latest
    needs:
      [dependency-check, secrets-scan, trivy-security-scan, monitoring-setup]

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Simulation - Construction des images
        run: |
          echo "ğŸ—ï¸ Construction de l'image backend..."
          docker build -t lootopia-back:${{ github.sha }} ./lootopia-back
          echo "âœ… Image backend construite avec succÃ¨s"

          echo "ğŸ—ï¸ Construction de l'image frontend..."
          docker build -t lootopia-front:${{ github.sha }} ./lootopia-front
          echo "âœ… Image frontend construite avec succÃ¨s"

      - name: Simulation - Test des conteneurs (mode fictif)
        run: |
          echo "ğŸ§ª Test du conteneur backend (simulation avec variables mockÃ©es)..."
          # CrÃ©ation d'un fichier .env fictif pour le backend
          cat > mock-backend.env << EOF
          NODE_ENV=production
          PORT=3000
          DATABASE_URL=postgresql://mockuser:mockpass@mockdb:5432/mockdb
          JWT_SECRET=mock-jwt-secret-for-testing-only
          CORS_ORIGIN=http://localhost:4200
          API_VERSION=v1
          LOG_LEVEL=info
          REDIS_URL=redis://mockredis:6379
          SMTP_HOST=mock-smtp.example.com
          SMTP_PORT=587
          SMTP_USER=mock@example.com
          SMTP_PASS=mockpassword
          EOF

          # Test du backend avec variables d'environnement mockÃ©es
          echo "ğŸ“ Variables d'environnement mockÃ©es crÃ©Ã©es"
          echo "ğŸ”§ Simulation du dÃ©marrage backend avec configuration fictive..."

          # Au lieu de vraiment dÃ©marrer le conteneur, on simule juste
          echo "âœ… Conteneur backend simulÃ© - Variables d'environnement: OK"
          echo "âœ… Conteneur backend simulÃ© - Configuration base de donnÃ©es: OK (mock)"
          echo "âœ… Conteneur backend simulÃ© - Port 3000: Disponible"
          echo "âœ… Conteneur backend simulÃ© - SantÃ©: OK"

          echo "ğŸ§ª Test du conteneur frontend (simulation)..."
          echo "âœ… Conteneur frontend simulÃ© - Build Angular: OK"
          echo "âœ… Conteneur frontend simulÃ© - Nginx: OK"
          echo "âœ… Conteneur frontend simulÃ© - Port 80: Disponible"
          echo "âœ… Conteneur frontend simulÃ© - SantÃ©: OK"

      - name: Simulation - Test de connectivitÃ© fictive
        run: |
          echo "ğŸ”— Test de connectivitÃ© entre services (simulation)..."
          echo "âœ… Frontend -> Backend: Connexion simulÃ©e OK"
          echo "âœ… Backend -> Base de donnÃ©es mockÃ©e: Connexion simulÃ©e OK"
          echo "âœ… Backend -> Redis mockÃ©: Connexion simulÃ©e OK"
          echo "âœ… Tests d'intÃ©gration: Tous passÃ©s (simulation)"

      - name: Simulation - DÃ©ploiement sur environnement fictif
        env:
          DEPLOY_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
        run: |
          echo "ğŸš€ Simulation du dÃ©ploiement sur l'environnement: $DEPLOY_ENV"
          echo "ğŸ“¦ Images Ã  dÃ©ployer:"
          echo "  - lootopia-back:${{ github.sha }}"
          echo "  - lootopia-front:${{ github.sha }}"

          echo "ğŸ”§ Simulation des Ã©tapes de dÃ©ploiement:"
          echo "  1. âœ… Connexion au serveur fictif"
          echo "  2. âœ… ArrÃªt des anciens conteneurs"
          echo "  3. âœ… TÃ©lÃ©chargement des nouvelles images"
          echo "  4. âœ… Configuration des variables d'environnement"
          echo "  5. âœ… DÃ©marrage des nouveaux conteneurs"
          echo "  6. âœ… VÃ©rification de la santÃ© des services"
          echo "  7. âœ… Mise Ã  jour du load balancer"
          echo "  8. âœ… Configuration des secrets et variables d'env"

          echo "ğŸŒ URLs fictives de dÃ©ploiement:"
          if [ "$DEPLOY_ENV" = "production" ]; then
            echo "  - Backend: https://api.lootopia-prod.example.com"
            echo "  - Frontend: https://lootopia-prod.example.com"
            echo "  - Base de donnÃ©es: postgresql://prod-db.example.com:5432/lootopia"
          else
            echo "  - Backend: https://api.lootopia-staging.example.com"
            echo "  - Frontend: https://lootopia-staging.example.com"
            echo "  - Base de donnÃ©es: postgresql://staging-db.example.com:5432/lootopia"
          fi

          echo "âœ… DÃ©ploiement fictif terminÃ© avec succÃ¨s!"

      - name: Simulation - VÃ©rification des services dÃ©ployÃ©s
        run: |
          echo "ğŸ” VÃ©rification des services dÃ©ployÃ©s (simulation)..."
          echo "ğŸ“Š MÃ©triques de santÃ© simulÃ©es:"
          echo "  - Backend API: âœ… RÃ©pondant (200 OK)"
          echo "  - Frontend: âœ… Accessible (200 OK)"
          echo "  - Base de donnÃ©es: âœ… ConnectÃ©e (simulation)"
          echo "  - Cache Redis: âœ… OpÃ©rationnel (simulation)"
          echo "  - Logs: âœ… CollectÃ©s et indexÃ©s"
          echo "  - MÃ©triques: âœ… CollectÃ©es par Prometheus"

      - name: Simulation - DÃ©marrage du monitoring
        run: |
          echo "ğŸ“Š DÃ©marrage du stack de monitoring..."
          # Simulation du dÃ©marrage de Prometheus et Grafana
          echo "  - âœ… Prometheus dÃ©marrÃ© sur http://monitoring.example.com:9090"
          echo "  - âœ… Grafana dÃ©marrÃ© sur http://monitoring.example.com:3001"
          echo "  - âœ… Node Exporter dÃ©marrÃ© sur http://monitoring.example.com:9100"
          echo "ğŸ“ˆ Dashboards Grafana configurÃ©s pour surveiller:"
          echo "  - MÃ©triques systÃ¨me (CPU, RAM, Disque)"
          echo "  - MÃ©triques applicatives (Backend NestJS)"
          echo "  - MÃ©triques frontend (Angular)"
          echo "  - MÃ©triques base de donnÃ©es (PostgreSQL)"
          echo "  - Logs et alertes configurÃ©s"

      - name: Simulation - Tests post-dÃ©ploiement
        run: |
          echo "ğŸ§ª ExÃ©cution des tests post-dÃ©ploiement (simulation)..."
          echo "âœ… Tests de fumÃ©e: PassÃ©s"
          echo "âœ… Tests d'intÃ©gration: PassÃ©s"
          echo "âœ… Tests de performance: PassÃ©s"
          echo "âœ… Tests de sÃ©curitÃ©: PassÃ©s"
          echo "âœ… Tests de rÃ©gression: PassÃ©s"

      - name: RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "ğŸ“‹ RÃ‰SUMÃ‰ DU DÃ‰PLOIEMENT FICTIF"
          echo "================================"
          echo "ğŸ”– Version: ${{ github.sha }}"
          echo "ğŸŒ¿ Branche: ${{ github.ref_name }}"
          echo "ğŸ·ï¸ Environnement: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}"
          echo "â° Heure: $(date)"
          echo "âœ… Statut: DÃ©ploiement simulÃ© avec succÃ¨s"
          echo "ğŸ“Š Monitoring: Actif (simulation)"
          echo "ğŸ§ª Tests: PassÃ©s (simulation)"
          echo "ğŸ”’ SÃ©curitÃ©: VÃ©rifiÃ©e (simulation)"
          echo "ğŸ—„ï¸ Base de donnÃ©es: ConnectÃ©e (simulation)"
          echo "ğŸ”‘ Variables d'environnement: ConfigurÃ©es (mock)"
          echo "ğŸ“ Logs: CollectÃ©s et indexÃ©s (simulation)"
